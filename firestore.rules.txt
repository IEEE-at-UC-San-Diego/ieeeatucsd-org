rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - only Executive Officers can update/delete, users can create/read their own
    match /users/{userId} {
      allow read: if request.auth != null && (
        // User can read their own document (full access)
        request.auth.uid == userId ||

        // Officers can read all user documents (full access)
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
            'General Officer', 'Executive Officer'
          ]
        )
      );
      
      // Create a separate public_profiles subcollection for public data
      match /public_profile/{profileId} {
        // Any authenticated user can read public profiles for leaderboard
        allow read: if request.auth != null;
        
        // Users can create/update their own public profile
        allow create, update: if request.auth != null && 
          request.auth.uid == userId &&
          profileId == 'profile';
          
        // Officers can manage all public profiles
        allow create, update, delete: if request.auth != null &&
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
            'General Officer', 'Executive Officer'
          ];
      }

      // Users can create their own user document
      allow create: if request.auth != null && request.auth.uid == userId;

      // Only Executive Officers can update and delete users
      allow update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Executive Officer';

      // Users can update their own profile and attendance/points
      allow update: if request.auth != null && 
        request.auth.uid == userId &&
        request.resource.data.keys().hasAny(['lastEventAttended', 'points', 'eventsAttended', 'name', 'major', 'graduationYear']);
    }

    // Invites collection - allow officers to manage, invited users to read/update their invites
    match /invites/{inviteId} {
      allow create, read, update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'General Officer', 'Executive Officer'
        ];

      allow read: if request.auth != null &&
        request.auth.token.email == resource.data.email;

      allow update: if request.auth != null &&
        request.auth.token.email == resource.data.email &&
        request.resource.data.status in ['accepted', 'declined'];
    }

    // Events collection - allow officers to manage, members to read published events and check in
    match /events/{eventId} {
      // Members can read published events (including files for public files only)
      allow read: if request.auth != null &&
        resource.data.published == true;

      // Officers can read, update, and delete all events
      allow read, update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'General Officer', 'Executive Officer'
        ];

      // Officers can create events
      allow create: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'General Officer', 'Executive Officer'
        ];

      // Allow members to update their own attendance (legacy attendees array)
      allow update: if request.auth != null &&
        resource.data.published == true &&
        request.resource.data.keys().hasOnly(['attendees']) &&
        request.auth.uid in request.resource.data.attendees &&
        !(request.auth.uid in resource.data.get('attendees', []));

      // Event attendees subcollection - for check-ins
      match /attendees/{attendeeId} {
        // Users can create their own check-in record
        allow create: if request.auth != null &&
          request.auth.uid == attendeeId &&
          request.auth.uid == request.resource.data.userId;

        // Users can read their own check-in record
        allow read: if request.auth != null &&
          request.auth.uid == attendeeId;

        // Officers can read and manage all attendee records
        allow read, update, delete: if request.auth != null &&
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
            'General Officer', 'Executive Officer'
          ];
      }
    }

    // Event requests collection - allow members to create/read/delete their own, officers to manage all
    match /event_requests/{requestId} {
      // Users can read and delete their own requests
      allow read, delete: if request.auth != null &&
        request.auth.uid == resource.data.requestedUser;

      // Users can update their own requests if they're still in submitted status
      allow update: if request.auth != null &&
        request.auth.uid == resource.data.requestedUser &&
        resource.data.status == 'submitted';

      // Officers can read, update, and delete all requests
      allow read, update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'General Officer', 'Executive Officer'
        ];

      // Users can create their own requests
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.requestedUser;
    }

    // Reimbursements collection - allow members to create/read/delete their own, officers to manage all
    match /reimbursements/{reimbursementId} {
      // Users can read and delete their own reimbursements
      allow read, delete: if request.auth != null &&
        request.auth.uid == resource.data.submittedBy;

      // Users can update their own reimbursements if they're still submitted
      allow update: if request.auth != null &&
        request.auth.uid == resource.data.submittedBy &&
        resource.data.status == 'submitted';

      // Officers can read, update, and delete all reimbursements
      allow read, update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'General Officer', 'Executive Officer'
        ];

      // Users can create their own reimbursements
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.submittedBy &&
        // Ensure required fields are present
        request.resource.data.keys().hasAll(['title', 'totalAmount', 'status', 'submittedBy', 'department', 'businessPurpose', 'expenses', 'submittedAt']) &&
        // Ensure submittedBy matches authenticated user
        request.resource.data.submittedBy == request.auth.uid &&
        // Ensure initial status is submitted
        request.resource.data.status == 'submitted';
    }

    // Logs collection - officers only
    match /logs/{logId} {
      allow read, write, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'General Officer', 'Executive Officer'
        ];
    }

    // Templates collection - officers only
    match /templates/{templateId} {
      allow read, write, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'General Officer', 'Executive Officer'
        ];
    }

    // Public profiles collection - top-level for easier querying
    match /public_profiles/{userId} {
      // Any authenticated user can read public profiles for leaderboard
      allow read: if request.auth != null;
      
      // Users can create/update their own public profile
      allow create, update: if request.auth != null && 
        request.auth.uid == userId;
        
      // Officers can manage all public profiles
      allow create, update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in [
          'General Officer', 'Executive Officer'
        ];
    }

    // Default deny for any other collections
    match /{document=**} {
      allow read, write, delete: if false;
    }
  }
}